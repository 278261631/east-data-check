{% extends 'base.html' %}

{% block title %}{{ date }} - East Data Check{% endblock %}

{% block content %}
<div class="page-layout">
    <div class="table-panel">
        <div class="card">
            <div class="header-row">
                <h2>{{ date }}</h2>
                <a href="{% url 'data:date_list' %}" class="btn-back">返回列表</a>
            </div>

            {% if error %}
            <div class="alert alert-error mt-1">{{ error }}</div>
            {% else %}
            <div class="table-wrapper mt-1">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            {% for h in headers %}
                            <th>{{ h }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr class="data-row" data-row-index="{{ row.index }}">
                            <td>{{ forloop.counter }}</td>
                            {% for cell in row.data %}
                            <td>{{ cell }}</td>
                            {% endfor %}
                        </tr>
                        {% empty %}
                        <tr><td colspan="{{ headers|length|add:1 }}">暂无数据</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="viewer-panel" id="viewerPanel">
        <div class="card">
            <h3 id="viewerHint">点击左侧表格行查看文件</h3>
            <div id="fileViewer" style="display:none;">
                <div class="file-viewer">
                    <div class="time-group" id="leftGroup">
                        <h4 id="leftTime">较早</h4>
                        <div class="fits-downloads" id="leftFits"></div>
                        <div class="image-container" id="leftImageContainer">
                            <img id="leftImage" src="" alt="Image">
                            <div class="image-label" id="leftLabel">NEW</div>
                        </div>
                    </div>
                    <div class="time-group" id="rightGroup">
                        <h4 id="rightTime">较晚</h4>
                        <div class="fits-downloads" id="rightFits"></div>
                        <div class="image-container" id="rightImageContainer">
                            <img id="rightImage" src="" alt="Image">
                            <div class="image-label" id="rightLabel">NEW</div>
                        </div>
                    </div>
                </div>
                <div class="links-section" id="linksSection">
                    <h4>查询链接</h4>
                    <div class="links" id="queryLinks"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .container { max-width: 100%; padding: 1rem; }
    .page-layout { display: grid; grid-template-columns: 400px 1fr; gap: 1rem; align-items: start; }
    .table-panel { min-width: 0; }
    .table-panel .card { max-height: calc(100vh - 120px); display: flex; flex-direction: column; overflow: hidden; }
    .viewer-panel .card { position: sticky; top: 1rem; }

    .header-row { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .btn-back { background: #6c757d; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; }
    .btn-back:hover { background: #5a6268; }
    .table-wrapper { overflow: auto; flex: 1; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    .data-table th, .data-table td { padding: 0.3rem; text-align: left; border-bottom: 1px solid #dee2e6; white-space: nowrap; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .data-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 1; }
    .data-table tbody tr { cursor: pointer; }
    .data-table tbody tr:hover { background: #e9ecef; }
    .data-table tbody tr.selected { background: #cce5ff; }

    .file-viewer { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .time-group { border: 1px solid #dee2e6; border-radius: 8px; padding: 0.5rem; }
    .time-group h4 { margin: 0 0 0.5rem 0; color: #495057; font-size: 0.9rem; }
    .fits-downloads { margin-bottom: 0.5rem; }
    .fits-downloads a { display: inline-block; margin-right: 0.25rem; margin-bottom: 0.25rem; padding: 0.2rem 0.4rem; background: #007bff; color: #fff; border-radius: 4px; text-decoration: none; font-size: 0.7rem; }
    .fits-downloads a:hover { background: #0056b3; }
    .image-container { position: relative; cursor: pointer; }
    .image-container img { width: 100%; height: auto; border-radius: 4px; background: #000; display: block; image-rendering: pixelated; }
    .image-label { position: absolute; top: 0.25rem; right: 0.25rem; background: rgba(0,123,255,0.9); color: #fff; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }

    .links-section { margin-top: 1rem; padding: 0.5rem; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa; }
    .links-section h4 { margin: 0 0 0.5rem 0; color: #495057; font-size: 0.9rem; }
    .links { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .links a { display: inline-block; padding: 0.3rem 0.6rem; background: #28a745; color: #fff; border-radius: 4px; text-decoration: none; font-size: 0.8rem; }
    .links a:hover { background: #218838; }
</style>
{% endblock %}

{% block extra_js %}
<script>
const DATE = '{{ date }}';

document.querySelectorAll('.data-row').forEach(row => {
    row.addEventListener('click', function() {
        const rowIndex = this.dataset.rowIndex;
        document.querySelectorAll('.data-row').forEach(r => r.classList.remove('selected'));
        this.classList.add('selected');
        loadRowFiles(rowIndex);
    });
});

function loadRowFiles(rowIndex) {
    fetch(`/data/${DATE}/row/${rowIndex}/files/`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            showFiles(data);
        });
}

function showFiles(data) {
    document.getElementById('viewerHint').style.display = 'none';
    document.getElementById('fileViewer').style.display = 'block';
    document.getElementById('leftTime').textContent = data.left_time || 'Earlier';
    document.getElementById('rightTime').textContent = data.right_time || 'Later';

    renderGroup('left', data.left);
    renderGroup('right', data.right);
    renderQueryLinks(data.ra_deg, data.dec_deg, data.ra_hms, data.dec_dms);
}

function renderQueryLinks(ra, dec, ra_hms, dec_dms) {
    const linksDiv = document.getElementById('queryLinks');
    linksDiv.innerHTML = '';

    if (!ra || !dec) {
        linksDiv.innerHTML = '<span style="color:#666;">暂无坐标信息</span>';
        return;
    }

    // Format for PS1 (needs space-separated format like "09.185 41.420")
    const ps1Ra = ra.toFixed(3);
    const ps1Dec = dec >= 0 ? dec.toFixed(3) : dec.toFixed(3);

    const links = [
        {name: 'Aladin', url: `https://aladin.u-strasbg.fr/AladinLite/?target=${ra}%20${dec}&fov=0.1&survey=P/DSS2/color`},
        {name: 'DLS', url: `https://www.legacysurvey.org/viewer/jpeg-cutout/?ra=${ra}&dec=${dec}&layer=ls-dr9&pixscale=0.5&bands=grz`},
        {name: 'PS1', url: `https://ps1images.stsci.edu/cgi-bin/ps1cutouts?pos=${ps1Ra}+${ps1Dec}&filter=color&filter=g&filter=r&filter=i&filter=z&filter=y&filetypes=stack&auxiliary=data&size=500&output_size=0&verbose=0&autoscale=99.500000&catlist=`},
        {name: 'Simbad', url: `http://simbad.u-strasbg.fr/simbad/sim-coo?Coord=${ra}%20${dec}&Radius.unit=arcsec&Radius=10`},
        {name: 'TNS', url: `https://www.wis-tns.org/search?ra=${ra}&decl=${dec}&radius=10&coords_unit=arcsec`},
        {name: 'VizieR', url: `http://vizier.u-strasbg.fr/viz-bin/VizieR-4?-c=${ra}+${dec}&-c.rs=10&-out.add=_r&-sort=_r&-out.max=4`},
        {name: 'VSX', url: `https://www.aavso.org/vsx/index.php?view=results.get&coords=${ra}+${dec}&format=d&size=10&geom=r&unit=3&order=9`}
    ];

    links.forEach(link => {
        const a = document.createElement('a');
        a.href = link.url;
        a.target = '_blank';
        a.textContent = link.name;
        linksDiv.appendChild(a);
    });
}

function renderGroup(side, files) {
    const fitsDiv = document.getElementById(side + 'Fits');
    const img = document.getElementById(side + 'Image');
    const label = document.getElementById(side + 'Label');
    const container = document.getElementById(side + 'ImageContainer');

    fitsDiv.innerHTML = '';
    img.src = '';
    img.style.display = 'none';
    label.style.display = 'none';

    let jpgNew = null, jpgLib = null;

    files.forEach(f => {
        if (f.type === 'fits') {
            const a = document.createElement('a');
            a.href = `/data/${DATE}/fits/${f.name}`;
            a.textContent = f.name;
            a.title = f.name;
            fitsDiv.appendChild(a);
        } else if (f.type === 'jpg') {
            if (f.subtype === 'new') jpgNew = f.name;
            else jpgLib = f.name;
        }
    });

    if (jpgNew || jpgLib) {
        img.style.display = 'block';
        label.style.display = 'block';
        img.dataset.jpgNew = jpgNew || '';
        img.dataset.jpgLib = jpgLib || '';
        img.dataset.current = 'new';
        img.src = `/data/${DATE}/image/${jpgNew || jpgLib}`;
        label.textContent = jpgNew ? 'NEW' : 'LIB';

        container.onclick = function() {
            toggleImage(side);
        };
    } else {
        container.onclick = null;
    }
}

function toggleImage(side) {
    const img = document.getElementById(side + 'Image');
    const label = document.getElementById(side + 'Label');
    const current = img.dataset.current;
    const jpgNew = img.dataset.jpgNew;
    const jpgLib = img.dataset.jpgLib;

    if (current === 'new' && jpgLib) {
        img.src = `/data/${DATE}/image/${jpgLib}`;
        img.dataset.current = 'lib';
        label.textContent = 'LIB';
    } else if (current === 'lib' && jpgNew) {
        img.src = `/data/${DATE}/image/${jpgNew}`;
        img.dataset.current = 'new';
        label.textContent = 'NEW';
    }
}
</script>
{% endblock %}

