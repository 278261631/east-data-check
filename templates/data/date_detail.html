{% extends 'base.html' %}

{% block title %}{{ date }} - East Data Check{% endblock %}

{% block content %}
<div class="page-layout">
    <div class="table-panel">
        <div class="card">
            <div class="header-row">
                <h2>{{ date }}</h2>
                <a href="{% url 'data:date_list' %}" class="btn-back">Back to List</a>
            </div>

            {% if error %}
            <div class="alert alert-error mt-1">{{ error }}</div>
            {% else %}
            <div class="table-wrapper mt-1">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            {% for h in headers %}
                            <th>{{ h }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr class="data-row" data-row-index="{{ row.index }}">
                            <td>{{ forloop.counter }}</td>
                            {% for cell in row.data %}
                            <td>{{ cell }}</td>
                            {% endfor %}
                        </tr>
                        {% empty %}
                        <tr><td colspan="{{ headers|length|add:1 }}">No data</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="viewer-panel" id="viewerPanel">
        <div class="card">
            <h3 id="viewerHint">Select a row to view files</h3>
            <div id="fileViewer" style="display:none;">
                <div class="file-viewer">
                    <div class="time-group" id="leftGroup">
                        <h4 id="leftTime">Earlier</h4>
                        <div class="fits-downloads" id="leftFits"></div>
                        <div class="image-container" id="leftImageContainer">
                            <img id="leftImage" src="" alt="Image">
                            <div class="image-label" id="leftLabel">NEW</div>
                        </div>
                    </div>
                    <div class="time-group" id="rightGroup">
                        <h4 id="rightTime">Later</h4>
                        <div class="fits-downloads" id="rightFits"></div>
                        <div class="image-container" id="rightImageContainer">
                            <img id="rightImage" src="" alt="Image">
                            <div class="image-label" id="rightLabel">NEW</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .container { max-width: 100%; padding: 1rem; }
    .page-layout { display: grid; grid-template-columns: 400px 1fr; gap: 1rem; align-items: start; }
    .table-panel { min-width: 0; }
    .table-panel .card { max-height: calc(100vh - 120px); display: flex; flex-direction: column; overflow: hidden; }
    .viewer-panel .card { position: sticky; top: 1rem; }

    .header-row { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .btn-back { background: #6c757d; color: #fff; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; }
    .btn-back:hover { background: #5a6268; }
    .table-wrapper { overflow: auto; flex: 1; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    .data-table th, .data-table td { padding: 0.3rem; text-align: left; border-bottom: 1px solid #dee2e6; white-space: nowrap; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .data-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 1; }
    .data-table tbody tr { cursor: pointer; }
    .data-table tbody tr:hover { background: #e9ecef; }
    .data-table tbody tr.selected { background: #cce5ff; }

    .file-viewer { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .time-group { border: 1px solid #dee2e6; border-radius: 8px; padding: 0.5rem; }
    .time-group h4 { margin: 0 0 0.5rem 0; color: #495057; font-size: 0.9rem; }
    .fits-downloads { margin-bottom: 0.5rem; }
    .fits-downloads a { display: inline-block; margin-right: 0.25rem; margin-bottom: 0.25rem; padding: 0.2rem 0.4rem; background: #007bff; color: #fff; border-radius: 4px; text-decoration: none; font-size: 0.7rem; }
    .fits-downloads a:hover { background: #0056b3; }
    .image-container { position: relative; cursor: pointer; }
    .image-container img { width: 100%; height: auto; border-radius: 4px; background: #000; display: block; image-rendering: pixelated; }
    .image-label { position: absolute; top: 0.25rem; right: 0.25rem; background: rgba(0,123,255,0.9); color: #fff; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
</style>
{% endblock %}

{% block extra_js %}
<script>
const DATE = '{{ date }}';

document.querySelectorAll('.data-row').forEach(row => {
    row.addEventListener('click', function() {
        const rowIndex = this.dataset.rowIndex;
        document.querySelectorAll('.data-row').forEach(r => r.classList.remove('selected'));
        this.classList.add('selected');
        loadRowFiles(rowIndex);
    });
});

function loadRowFiles(rowIndex) {
    fetch(`/data/${DATE}/row/${rowIndex}/files/`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            showFiles(data);
        });
}

function showFiles(data) {
    document.getElementById('viewerHint').style.display = 'none';
    document.getElementById('fileViewer').style.display = 'block';
    document.getElementById('leftTime').textContent = data.left_time || 'Earlier';
    document.getElementById('rightTime').textContent = data.right_time || 'Later';

    renderGroup('left', data.left);
    renderGroup('right', data.right);
}

function renderGroup(side, files) {
    const fitsDiv = document.getElementById(side + 'Fits');
    const img = document.getElementById(side + 'Image');
    const label = document.getElementById(side + 'Label');
    const container = document.getElementById(side + 'ImageContainer');

    fitsDiv.innerHTML = '';
    img.src = '';
    img.style.display = 'none';
    label.style.display = 'none';

    let jpgNew = null, jpgLib = null;

    files.forEach(f => {
        if (f.type === 'fits') {
            const a = document.createElement('a');
            a.href = `/data/${DATE}/fits/${f.name}`;
            a.textContent = f.name;
            a.title = f.name;
            fitsDiv.appendChild(a);
        } else if (f.type === 'jpg') {
            if (f.subtype === 'new') jpgNew = f.name;
            else jpgLib = f.name;
        }
    });

    if (jpgNew || jpgLib) {
        img.style.display = 'block';
        label.style.display = 'block';
        img.dataset.jpgNew = jpgNew || '';
        img.dataset.jpgLib = jpgLib || '';
        img.dataset.current = 'new';
        img.src = `/data/${DATE}/image/${jpgNew || jpgLib}`;
        label.textContent = jpgNew ? 'NEW' : 'LIB';

        container.onclick = function() {
            toggleImage(side);
        };
    } else {
        container.onclick = null;
    }
}

function toggleImage(side) {
    const img = document.getElementById(side + 'Image');
    const label = document.getElementById(side + 'Label');
    const current = img.dataset.current;
    const jpgNew = img.dataset.jpgNew;
    const jpgLib = img.dataset.jpgLib;

    if (current === 'new' && jpgLib) {
        img.src = `/data/${DATE}/image/${jpgLib}`;
        img.dataset.current = 'lib';
        label.textContent = 'LIB';
    } else if (current === 'lib' && jpgNew) {
        img.src = `/data/${DATE}/image/${jpgNew}`;
        img.dataset.current = 'new';
        label.textContent = 'NEW';
    }
}
</script>
{% endblock %}

