{% extends 'base.html' %}

{% block title %}{{ date }} - East Data Check{% endblock %}

{% block content %}
<div class="page-layout">
    <div class="table-panel">
        <div class="card">
            <div class="header-row">
                <h2>{{ date }}</h2>
                <div class="online-users">
                    <span class="online-label">在线:</span>
                    <span id="onlineUsersList">-</span>
                </div>
                <a href="{% url 'data:date_list' %}" class="btn-back">返回列表</a>
            </div>

            {% if excel_filename %}
            <div class="excel-filename">
                <span class="filename-label">数据文件:</span>
                <span class="filename-text">{{ excel_filename }}</span>
                <button class="btn-sync" id="btnSyncRows" onclick="manualSyncExcelRows()">
                    <span id="syncBtnText">同步新行</span>
                </button>
                <span class="sync-countdown" id="syncCountdown">
                    <span class="countdown-label">下次自动同步:</span>
                    <span class="countdown-time" id="countdownTime">--:--</span>
                </span>
            </div>
            {% endif %}

            {% if error %}
            <div class="alert alert-error mt-1">{{ error }}</div>
            {% else %}
            <div class="table-wrapper mt-1">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Judge</th>
                            <th>User</th>
                            {% for h in headers %}
                            <th>{{ h }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr class="data-row" data-row-index="{{ row.index }}">
                            <td>{{ forloop.counter }}</td>
                            <td class="judge-cell" data-row="{{ row.index }}"></td>
                            <td class="user-cell" data-row="{{ row.index }}"></td>
                            {% for cell in row.data %}
                            <td>{{ cell }}</td>
                            {% endfor %}
                        </tr>
                        {% empty %}
                        <tr><td colspan="{{ headers|length|add:3 }}">暂无数据</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="viewer-panel" id="viewerPanel">
        <div class="card">
            <h3 id="viewerHint">点击左侧表格行查看文件</h3>
            <div id="fileViewer" style="display:none;">
                <div class="file-viewer">
                    <div class="time-group" id="leftGroup">
                        <h4 id="leftTime">较早</h4>
                        <div class="fits-downloads" id="leftFits"></div>
                        <div class="image-container" id="leftImageContainer">
                            <img id="leftImage" src="" alt="Image">
                            <div class="image-label" id="leftLabel">NEW</div>
                        </div>
                    </div>
                    <div class="time-group" id="rightGroup">
                        <h4 id="rightTime">较晚</h4>
                        <div class="fits-downloads" id="rightFits"></div>
                        <div class="image-container" id="rightImageContainer">
                            <img id="rightImage" src="" alt="Image">
                            <div class="image-label" id="rightLabel">NEW</div>
                        </div>
                    </div>
                </div>
                <div class="links-section" id="linksSection">
                    <div class="links-row">
                        <div class="links-left">
                            <div class="links" id="queryLinks"></div>
                            <span class="coords-info" id="coordsInfo"></span>
                        </div>
                        <div class="judge-right">
                            <div class="judge-buttons">
                                <button class="btn-judge btn-exclude" id="btnExclude" onclick="submitJudgment('exclude')">排除</button>
                                <button class="btn-judge btn-suspect" id="btnSuspect" onclick="submitJudgment('suspect')">可疑</button>
                            </div>
                            <div class="judge-status-wrapper">
                                <div class="judge-status" id="judgeStatus"></div>
                                <button class="btn-judge btn-cancel" id="btnCancel" onclick="submitJudgment('cancel')">取消判断</button>
                            </div>
                            <div class="remark-section">
                                <textarea id="remarkInput" class="remark-input" placeholder="备注..." rows="2"></textarea>
                                <button class="btn-remark" onclick="submitRemark()">保存备注</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .container { max-width: 100%; padding: 0.1rem; }
    .page-layout { display: grid; grid-template-columns: 400px 1fr; gap: 0.5rem; align-items: start; }
    .table-panel { min-width: 0; }
    .table-panel .card { max-height: calc(100vh - 80px); display: flex; flex-direction: column; overflow: hidden; padding: 1px 0.8rem; }
    .viewer-panel .card { position: sticky; top: 0.5rem; padding: 1px 0.8rem; }

    .header-row { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; gap: 0.5rem; margin-bottom: 0.5rem; }
    .header-row h2 { font-size: 1.2rem; margin: 0; }
    .excel-filename { background: #fff3e0; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid #ff9800; display: flex; align-items: center; gap: 0.5rem; }
    .filename-label { color: #e65100; font-weight: 600; margin-right: 0.3rem; }
    .filename-text { color: #424242; font-family: monospace; word-break: break-all; flex: 1; }
    .btn-sync { background: #4caf50; color: #fff; padding: 0.25rem 0.6rem; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: all 0.2s; white-space: nowrap; }
    .btn-sync:hover { background: #45a049; }
    .btn-sync:active { background: #3d8b40; }
    .btn-sync:disabled { background: #9e9e9e; cursor: not-allowed; }
    .sync-countdown { display: flex; align-items: center; gap: 0.3rem; background: #e3f2fd; padding: 0.2rem 0.5rem; border-radius: 3px; }
    .countdown-label { color: #1565c0; font-size: 0.7rem; font-weight: 600; }
    .countdown-time { color: #0d47a1; font-size: 0.75rem; font-weight: 700; font-family: monospace; min-width: 45px; }
    .online-users { display: flex; align-items: center; gap: 0.3rem; background: #e8f5e9; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
    .online-label { color: #2e7d32; font-weight: 600; }
    #onlineUsersList { color: #1b5e20; }
    .online-user { display: inline-block; background: #4caf50; color: #fff; padding: 0.1rem 0.4rem; border-radius: 10px; margin: 0 0.1rem; font-size: 0.7rem; }
    .online-user.current { background: #1976d2; }
    .btn-back { background: #6c757d; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; text-decoration: none; font-size: 0.85rem; }
    .btn-back:hover { background: #5a6268; }
    .table-wrapper { overflow: auto; flex: 1; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
    .data-table th, .data-table td { padding: 0.2rem; text-align: left; border-bottom: 1px solid #dee2e6; white-space: nowrap; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .data-table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; z-index: 1; }
    .data-table tbody tr { cursor: pointer; }
    .data-table tbody tr:hover { background: #e9ecef; }
    .data-table tbody tr.selected { background: #cce5ff; }
    .data-table tbody tr.other-user { background: #fff3e0; }
    .user-cell { min-width: 60px; }
    .user-badge { display: inline-block; background: #ff9800; color: #fff; padding: 0.1rem 0.3rem; border-radius: 8px; font-size: 0.6rem; }
    .user-badge.current { background: #1976d2; }

    .file-viewer { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .time-group { border: 1px solid #dee2e6; border-radius: 6px; padding: 0.4rem; }
    .time-group h4 { margin: 0 0 0.3rem 0; color: #495057; font-size: 0.85rem; }
    .fits-downloads { margin-bottom: 0.3rem; }
    .fits-downloads a { display: inline-block; margin-right: 0.25rem; margin-bottom: 0.25rem; padding: 0.2rem 0.4rem; background: #007bff; color: #fff; border-radius: 3px; text-decoration: none; font-size: 0.8rem; }
    .fits-downloads a:hover { background: #0056b3; }
    .image-container { position: relative; cursor: pointer; }
    .image-container img { width: 100%; height: auto; border-radius: 4px; background: #000; display: block; image-rendering: pixelated; }
    .image-label { position: absolute; top: 0.2rem; right: 0.2rem; background: rgba(0,123,255,0.9); color: #fff; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.65rem; font-weight: bold; }

    .links-section { margin-top: 0.4rem; padding: 0.4rem 0.5rem; border: 1px solid #dee2e6; border-radius: 4px; background: #f8f9fa; }
    .links-row { display: flex; align-items: flex-start; gap: 1rem; }
    .links-left { display: flex; flex-direction: column; gap: 0.3rem; }
    .links { display: flex; flex-wrap: wrap; gap: 0.25rem; align-items: center; }
    .links a { display: inline-block; padding: 0.2rem 0.45rem; background: #28a745; color: #fff; border-radius: 3px; text-decoration: none; font-size: 0.75rem; }
    .links a:hover { background: #218838; }
    .coords-info { font-size: 0.75rem; color: #495057; white-space: nowrap; background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 3px; font-family: monospace; }

    .judge-right { display: flex; align-items: flex-start; gap: 0.5rem; flex: 1; }
    .judge-buttons { display: flex; flex-direction: column; gap: 0.3rem; }
    .judge-status-wrapper { display: flex; flex-direction: column; align-items: flex-start; gap: 0.2rem; }
    .btn-judge { padding: 0.4rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s; white-space: nowrap; }
    .btn-exclude { background: #9e9e9e; color: #fff; }
    .btn-exclude:hover { background: #757575; }
    .btn-exclude.active { background: #616161; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
    .btn-suspect { background: #ff5722; color: #fff; }
    .btn-suspect:hover { background: #e64a19; }
    .btn-suspect.active { background: #d84315; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
    .btn-cancel { background: #607d8b; color: #fff; font-size: 0.7rem; padding: 0.15rem 0.4rem; margin-top: 0.2rem; }
    .btn-cancel:hover { background: #455a64; }
    .judge-status { font-size: 0.7rem; color: #666; display: flex; flex-direction: column; gap: 0.1rem; padding-top: 0.2rem; }
    .judge-status .judge-item { display: block; }
    .judge-status .judge-user { font-weight: 600; }
    .judge-status .judge-exclude { color: #757575; }
    .judge-status .judge-suspect { color: #ff5722; }

    .remark-section { display: flex; gap: 0.25rem; align-items: flex-start; }
    .remark-input { width: 400px; padding: 0.25rem 0.4rem; border: 1px solid #ced4da; border-radius: 3px; font-size: 0.75rem; font-family: inherit; resize: vertical; }
    .remark-input:focus { outline: none; border-color: #80bdff; }
    .btn-remark { padding: 0.25rem 0.5rem; background: #17a2b8; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem; white-space: nowrap; }
    .btn-remark:hover { background: #138496; }

    .data-table tbody tr.row-exclude { background: #f5f5f5; }
    .data-table tbody tr.row-suspect { background: #fff3e0; }
    .data-table tbody tr.row-exclude.selected { background: #e0e0e0; }
    .data-table tbody tr.row-suspect.selected { background: #ffe0b2; }
    .judge-cell { min-width: 70px; text-align: center; }
    .judge-badge { display: inline-block; padding: 0.1rem 0.3rem; border-radius: 8px; font-size: 0.6rem; font-weight: 600; }
    .judge-badge.exclude { background: #9e9e9e; color: #fff; }
    .judge-badge.suspect { background: #ff5722; color: #fff; }
    .judge-by { display: block; font-size: 0.55rem; color: #666; margin-top: 1px; }
</style>
{% endblock %}

{% block extra_js %}
<script>
const DATE = '{{ date }}';
const CURRENT_USER = '{{ request.user.username }}';
const AUTO_SYNC_INTERVAL = {{ auto_sync_interval }};  // seconds
const INITIAL_ROW_COUNT = {{ initial_row_count }};  // 页面加载时的行数
let currentRow = null;
let statusInterval = null;
let syncCountdownInterval = null;
let syncCheckInterval = null;
let syncTimeRemaining = AUTO_SYNC_INTERVAL;
let isSyncing = false;
let lastSyncCheckTime = Date.now() / 1000;  // 记录上次检查同步状态的时间

document.querySelectorAll('.data-row').forEach(row => {
    row.addEventListener('click', function() {
        const rowIndex = this.dataset.rowIndex;
        document.querySelectorAll('.data-row').forEach(r => r.classList.remove('selected'));
        this.classList.add('selected');
        currentRow = rowIndex;
        loadRowFiles(rowIndex);
        updateUserStatus(rowIndex);
    });
});

function loadRowFiles(rowIndex) {
    fetch(`/east-data/${DATE}/row/${rowIndex}/files/`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            showFiles(data);
        });
}

function updateUserStatus(rowIndex) {
    fetch(`/east-data/${DATE}/status/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({row_index: rowIndex})
    });
}

function fetchStatus() {
    fetch(`/east-data/${DATE}/status/`)
        .then(r => r.json())
        .then(data => {
            updateOnlineUsers(data.users, data.current_user);
            updateRowUsers(data.users, data.current_user);
        });
}

function updateOnlineUsers(users, currentUser) {
    const usersList = document.getElementById('onlineUsersList');
    if (Object.keys(users).length === 0) {
        usersList.innerHTML = '-';
        return;
    }

    const userBadges = Object.keys(users).map(username => {
        const isCurrent = username === currentUser;
        return `<span class="online-user ${isCurrent ? 'current' : ''}">${username}</span>`;
    }).join('');

    usersList.innerHTML = userBadges;
}

function updateRowUsers(users, currentUser) {
    // Clear all user cells
    document.querySelectorAll('.user-cell').forEach(cell => {
        cell.innerHTML = '';
    });

    // Clear other-user class
    document.querySelectorAll('.data-row').forEach(row => {
        row.classList.remove('other-user');
    });

    // Update user cells
    Object.entries(users).forEach(([username, data]) => {
        const rowIndex = data.row;
        if (rowIndex) {
            const cell = document.querySelector(`.user-cell[data-row="${rowIndex}"]`);
            const row = document.querySelector(`.data-row[data-row-index="${rowIndex}"]`);
            if (cell) {
                const isCurrent = username === currentUser;
                const badge = document.createElement('span');
                badge.className = `user-badge ${isCurrent ? 'current' : ''}`;
                badge.textContent = username;
                cell.appendChild(badge);

                if (!isCurrent && row) {
                    row.classList.add('other-user');
                }
            }
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Judgments data
let judgmentsData = {};

// Start polling for status updates
statusInterval = setInterval(fetchStatus, 2000);
fetchStatus();

// Fetch judgments
fetchJudgments();
setInterval(fetchJudgments, 5000);

// Update status periodically if user is viewing a row
setInterval(() => {
    if (currentRow) {
        updateUserStatus(currentRow);
    }
}, 3000);

function fetchJudgments() {
    fetch(`/east-data/${DATE}/judgments/`)
        .then(r => r.json())
        .then(data => {
            if (data.error) return;
            judgmentsData = data.judgments;
            updateJudgmentDisplay();
            if (currentRow) {
                updateJudgeStatus(currentRow);
            }
        });
}

function updateJudgmentDisplay() {
    // Clear all judge cells and row classes
    document.querySelectorAll('.judge-cell').forEach(cell => {
        cell.innerHTML = '';
    });
    document.querySelectorAll('.data-row').forEach(row => {
        row.classList.remove('row-exclude', 'row-suspect');
    });

    // Update judge cells
    Object.entries(judgmentsData).forEach(([rowIdx, data]) => {
        const cell = document.querySelector(`.judge-cell[data-row="${rowIdx}"]`);
        const row = document.querySelector(`.data-row[data-row-index="${rowIdx}"]`);

        if (cell && data.final) {
            const badge = document.createElement('span');
            badge.className = `judge-badge ${data.final}`;
            badge.textContent = data.final === 'exclude' ? '排除' : '可疑';
            cell.appendChild(badge);

            // Show who made the final judgment
            if (data.final_by) {
                const bySpan = document.createElement('span');
                bySpan.className = 'judge-by';
                bySpan.textContent = data.final_by;
                cell.appendChild(bySpan);
            }
        }

        if (row && data.final) {
            row.classList.add(`row-${data.final}`);
        }
    });
}

function updateJudgeStatus(rowIndex, forceUpdateRemark = false) {
    const statusDiv = document.getElementById('judgeStatus');
    const remarkInput = document.getElementById('remarkInput');
    const data = judgmentsData[rowIndex];

    // Reset button states
    document.getElementById('btnExclude').classList.remove('active');
    document.getElementById('btnSuspect').classList.remove('active');

    // Only reset remark if forced (row changed) or input not focused
    if (forceUpdateRemark) {
        remarkInput.value = '';
    }

    if (!data) {
        statusDiv.innerHTML = '<span style="color:#999;">暂无判定</span>';
        return;
    }

    // Highlight current user's judgment
    if (data.users && data.users[CURRENT_USER]) {
        const myJudge = data.users[CURRENT_USER];
        if (myJudge === 'exclude') {
            document.getElementById('btnExclude').classList.add('active');
        } else if (myJudge === 'suspect') {
            document.getElementById('btnSuspect').classList.add('active');
        }
    }

    // Show all judgments
    let html = '';
    if (data.users) {
        Object.entries(data.users).forEach(([user, judge]) => {
            const judgeClass = judge === 'exclude' ? 'judge-exclude' : 'judge-suspect';
            const judgeText = judge === 'exclude' ? '排除' : '可疑';
            html += `<div class="judge-item"><span class="judge-user">${user}:</span> <span class="${judgeClass}">${judgeText}</span></div>`;
        });
    }
    statusDiv.innerHTML = html || '<span style="color:#999;">暂无判定</span>';

    // Set remark value only if forced or input not focused
    if (forceUpdateRemark || document.activeElement !== remarkInput) {
        remarkInput.value = data.remark || '';
    }
}

function submitJudgment(judgment) {
    if (!currentRow) {
        alert('请先选择一行数据');
        return;
    }

    fetch(`/east-data/${DATE}/row/${currentRow}/judge/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({judgment: judgment})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        // Refresh judgments
        fetchJudgments();
    });
}

function submitRemark() {
    if (!currentRow) {
        alert('请先选择一行数据');
        return;
    }

    const remark = document.getElementById('remarkInput').value;

    fetch(`/east-data/${DATE}/row/${currentRow}/remark/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({remark: remark})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        // Refresh judgments
        fetchJudgments();
    });
}

function showFiles(data) {
    document.getElementById('viewerHint').style.display = 'none';
    document.getElementById('fileViewer').style.display = 'block';
    document.getElementById('leftTime').textContent = data.left_time || 'Earlier';
    document.getElementById('rightTime').textContent = data.right_time || 'Later';

    renderGroup('left', data.left);
    renderGroup('right', data.right);
    // Use the later observation time for MPC query
    const obsTime = data.right_time || data.left_time || null;
    renderQueryLinks(data.ra_deg, data.dec_deg, data.ra_hms, data.dec_dms, obsTime);
    updateJudgeStatus(currentRow, true);  // Force update remark when row changes
}

function renderQueryLinks(ra, dec, ra_hms, dec_dms, obsTime) {
    const linksDiv = document.getElementById('queryLinks');
    const coordsDiv = document.getElementById('coordsInfo');
    linksDiv.innerHTML = '';
    coordsDiv.innerHTML = '';

    if (!ra || !dec) {
        linksDiv.innerHTML = '<span style="color:#666;">暂无坐标信息</span>';
        return;
    }

    // Format for PS1 (needs space-separated format like "09.185 41.420")
    const ps1Ra = ra.toFixed(3);
    const ps1Dec = dec >= 0 ? dec.toFixed(3) : dec.toFixed(3);

    // Format for MPC (needs date and HMS/DMS format)
    const dateStr = '{{ date }}';
    let mpcYear = null;
    let mpcMonth = null;
    let mpcDay = null;
    let mpcTimeError = null;

    // Calculate precise day fraction from observation time
    // obsTime format: "YYYY-MM-DD HH:MM:SS" or similar
    if (obsTime) {
        const dateMatch = obsTime.match(/(\d{4})-(\d{2})-(\d{2})/);
        const timeMatch = obsTime.match(/(\d{2}):(\d{2}):(\d{2})/);

        if (dateMatch && timeMatch) {
            mpcYear = dateMatch[1];
            mpcMonth = parseInt(dateMatch[2]);
            const dayNum = parseInt(dateMatch[3]);
            const hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]);
            const seconds = parseInt(timeMatch[3]);
            const dayFraction = (hours + minutes / 60 + seconds / 3600) / 24;
            mpcDay = (dayNum + dayFraction).toFixed(4);
        } else if (timeMatch) {
            // Only time available, use date from dateStr
            mpcYear = dateStr.substring(0, 4);
            mpcMonth = parseInt(dateStr.substring(4, 6));
            const dayNum = parseInt(dateStr.substring(6, 8));
            const hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]);
            const seconds = parseInt(timeMatch[3]);
            const dayFraction = (hours + minutes / 60 + seconds / 3600) / 24;
            mpcDay = (dayNum + dayFraction).toFixed(4);
        } else {
            mpcTimeError = 'Time format error: ' + obsTime;
        }
    } else {
        mpcTimeError = 'No observation time';
    }

    // Convert RA from degrees to HMS format (HH MM SS.s)
    const raHours = ra / 15;
    const raH = Math.floor(raHours);
    const raM = Math.floor((raHours - raH) * 60);
    const raS = ((raHours - raH) * 60 - raM) * 60;
    const raSStr = raS < 10 ? '0' + raS.toFixed(1) : raS.toFixed(1);
    const mpcRa = `${String(raH).padStart(2, '0')}%20${String(raM).padStart(2, '0')}%20${raSStr}`;
    // Convert DEC from degrees to DMS format (±DD MM SS.s)
    const decSign = dec >= 0 ? '%2B' : '-';
    const decAbs = Math.abs(dec);
    const decD = Math.floor(decAbs);
    const decM = Math.floor((decAbs - decD) * 60);
    const decS = ((decAbs - decD) * 60 - decM) * 60;
    const decSStr = decS < 10 ? '0' + decS.toFixed(2) : decS.toFixed(2);
    const mpcDec = `${decSign}${String(decD).padStart(2, '0')}%20${String(decM).padStart(2, '0')}%20${decSStr}`;

    // Format HMS/DMS for display
    const decSignDisplay = dec >= 0 ? '+' : '-';
    const raHmsDisplay = `${String(raH).padStart(2, '0')}h ${String(raM).padStart(2, '0')}m ${raSStr}s`;
    const decDmsDisplay = `${decSignDisplay}${String(decD).padStart(2, '0')}° ${String(decM).padStart(2, '0')}' ${decSStr}"`;

    const links = [
        {name: 'Aladin', url: `https://aladin.u-strasbg.fr/AladinLite/?target=${ra}%20${dec}&fov=0.1&survey=P/DSS2/color`},
        {name: 'DLS', url: `https://www.legacysurvey.org/viewer/jpeg-cutout/?ra=${ra}&dec=${dec}&layer=ls-dr9&pixscale=0.5&bands=grz`},
        {name: 'PS1', url: `https://ps1images.stsci.edu/cgi-bin/ps1cutouts?pos=${ps1Ra}+${ps1Dec}&filter=color&filter=g&filter=r&filter=i&filter=z&filter=y&filetypes=stack&auxiliary=data&size=500&output_size=0&verbose=0&autoscale=99.500000&catlist=`},
        {name: 'Simbad', url: `http://simbad.u-strasbg.fr/simbad/sim-coo?Coord=${ra}%20${dec}&Radius.unit=arcsec&Radius=10`},
        {name: 'TNS', url: `https://www.wis-tns.org/search?ra=${ra}&decl=${dec}&radius=10&coords_unit=arcsec`},
        {name: 'VizieR', url: `http://vizier.u-strasbg.fr/viz-bin/VizieR-4?-c=${ra}+${dec}&-c.rs=10&-out.add=_r&-sort=_r&-out.max=4`},
        {name: 'VSX', url: `https://www.aavso.org/vsx/index.php?view=results.get&coords=${ra}+${dec}&format=d&size=10&geom=r&unit=3&order=9`}
    ];

    // Add MPC link only if time is valid
    if (!mpcTimeError) {
        links.unshift({name: 'MPC', url: `https://data.minorplanetcenter.net/cgi-bin/mpcheck.cgi?year=${mpcYear}&month=${mpcMonth}&day=${mpcDay}&which=pos&ra=${mpcRa}&decl=${mpcDec}&TextArea=&limit=20&oc=N89&radius=10&sort=d&mot=h&tmot=s&pdes=u&needed=f&ps=n&type=p`});
    }

    links.forEach(link => {
        const a = document.createElement('a');
        a.href = link.url;
        a.target = '_blank';
        a.textContent = link.name;
        linksDiv.appendChild(a);
    });

    // Show MPC error if any
    if (mpcTimeError) {
        const errSpan = document.createElement('span');
        errSpan.style.cssText = 'color: #dc3545; font-size: 0.75rem; margin-left: 0.5rem;';
        errSpan.textContent = `[MPC: ${mpcTimeError}]`;
        linksDiv.appendChild(errSpan);
    }

    // Display coordinates info (single line)
    coordsDiv.innerHTML = `${ra.toFixed(4)}° ${dec >= 0 ? '+' : ''}${dec.toFixed(4)}° | ${raHmsDisplay} ${decDmsDisplay}`;
}

function renderGroup(side, files) {
    const fitsDiv = document.getElementById(side + 'Fits');
    const img = document.getElementById(side + 'Image');
    const label = document.getElementById(side + 'Label');
    const container = document.getElementById(side + 'ImageContainer');

    fitsDiv.innerHTML = '';
    img.src = '';
    img.style.display = 'none';
    label.style.display = 'none';

    let jpgNew = null, jpgLib = null;

    files.forEach(f => {
        if (f.type === 'fits') {
            const a = document.createElement('a');
            a.href = `/east-data/${DATE}/fits/${f.name}`;
            a.textContent = f.name;
            a.title = f.name;
            fitsDiv.appendChild(a);
        } else if (f.type === 'jpg') {
            if (f.subtype === 'new') jpgNew = f.name;
            else jpgLib = f.name;
        }
    });

    if (jpgNew || jpgLib) {
        img.style.display = 'block';
        label.style.display = 'block';
        img.dataset.jpgNew = jpgNew || '';
        img.dataset.jpgLib = jpgLib || '';
        img.dataset.current = 'new';
        img.src = `/east-data/${DATE}/image/${jpgNew || jpgLib}`;
        label.textContent = jpgNew ? 'NEW' : 'LIB';

        container.onclick = function() {
            toggleImage(side);
        };
    } else {
        container.onclick = null;
    }
}

function toggleImage(side) {
    const img = document.getElementById(side + 'Image');
    const label = document.getElementById(side + 'Label');
    const current = img.dataset.current;
    const jpgNew = img.dataset.jpgNew;
    const jpgLib = img.dataset.jpgLib;

    if (current === 'new' && jpgLib) {
        img.src = `/east-data/${DATE}/image/${jpgLib}`;
        img.dataset.current = 'lib';
        label.textContent = 'LIB';
    } else if (current === 'lib' && jpgNew) {
        img.src = `/east-data/${DATE}/image/${jpgNew}`;
        img.dataset.current = 'new';
        label.textContent = 'NEW';
    }
}

// 同步Excel行的核心函数
function syncExcelRows(isAutoSync = false) {
    const btn = document.getElementById('btnSyncRows');
    const btnText = document.getElementById('syncBtnText');

    if (isSyncing) return;
    isSyncing = true;

    // 禁用按钮并显示加载状态
    btn.disabled = true;
    btnText.textContent = '同步中...';

    // 创建FormData传递客户端行数
    const formData = new FormData();
    formData.append('client_row_count', INITIAL_ROW_COUNT);

    fetch(`/east-data/${DATE}/sync-rows/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        isSyncing = false;
        btn.disabled = false;
        btnText.textContent = '同步新行';

        if (data.success) {
            // 检查是否需要刷新（服务器端的行数比客户端多）
            if (data.should_refresh) {
                const msg = isAutoSync
                    ? `检测到新数据！\n当前总行数: ${data.total_rows}\n页面加载时: ${INITIAL_ROW_COUNT}行\n\n页面将刷新以显示新数据。`
                    : `同步完成！\n新增行数: ${data.added_rows}\n当前总行数: ${data.total_rows}\n\n页面将刷新以显示新数据。`;
                alert(msg);
                location.reload();
            }else if (data.added_rows > 0) {
                // 虽然有新行但客户端已经是最新的（可能是其他用户先同步了）
                const msg = `同步成功！\n新增行数: ${data.added_rows}\n当前总行数: ${data.total_rows}\n\n页面将刷新以显示新数据。`;
                alert(msg);
                location.reload();
            } else {
                // 没有新行
                if (!isAutoSync) {
                    alert(data.message || '无新行需要同步，当前数据已是最新');
                }
                // 重置倒计时
                resetSyncCountdown();
            }
        } else {
            if (!isAutoSync) {
                alert('同步失败：' + (data.message || '未知错误'));
            }
            // 重置倒计时
            resetSyncCountdown();
        }
    })
    .catch(error => {
        isSyncing = false;
        btn.disabled = false;
        btnText.textContent = '同步新行';
        if (!isAutoSync) {
            alert('同步失败：' + error.message);
        }
        // 重置倒计时
        resetSyncCountdown();
    });
}

// 手动同步（需要确认）
function manualSyncExcelRows() {
    if (isSyncing) return;

    // 确认操作
    if (!confirm('确定要从原始Excel同步新行到当前工作副本吗？')) {
        return;
    }

    // 停止倒计时
    if (syncCountdownInterval) {
        clearInterval(syncCountdownInterval);
    }

    syncExcelRows(false);
}

// 更新倒计时显示
function updateCountdownDisplay() {
    const countdownTime = document.getElementById('countdownTime');
    if (!countdownTime) return;

    const minutes = Math.floor(syncTimeRemaining / 60);
    const seconds = syncTimeRemaining % 60;
    countdownTime.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// 开始倒计时
function startSyncCountdown() {
    syncTimeRemaining = AUTO_SYNC_INTERVAL;
    updateCountdownDisplay();

    syncCountdownInterval = setInterval(() => {
        syncTimeRemaining--;

        if (syncTimeRemaining <= 0) {
            // 倒计时结束，执行自动同步
            clearInterval(syncCountdownInterval);
            syncExcelRows(true);
        } else {
            updateCountdownDisplay();
        }
    }, 1000);
}

// 重置倒计时
function resetSyncCountdown() {
    if (syncCountdownInterval) {
        clearInterval(syncCountdownInterval);
    }
    startSyncCountdown();
}

// 检查是否有其他用户同步了新数据
function checkSyncStatus() {
    fetch(`/east-data/${DATE}/sync-status/?last_check=${lastSyncCheckTime}&client_row_count=${INITIAL_ROW_COUNT}`)
        .then(r => r.json())
        .then(data => {
            lastSyncCheckTime = data.last_sync_time || lastSyncCheckTime;

            if (data.has_new_data) {
                // ��其他用户同步了新数据，提示并刷新页面
                const syncedBy = data.synced_by || '其他用户';
                const totalRows = data.total_rows || 0;

                alert(`检测到新数据！\n同步者: ${syncedBy}\n服务器总行数: ${totalRows}\n您的页面: ${INITIAL_ROW_COUNT}行\n\n页面将自动刷新。`);
                location.reload();
            }
        })
        .catch(error => {
            console.error('检查同步状态失败:', error);
        });
}

// 开始定期检查同步状态
function startSyncStatusCheck() {
    // 每5秒检查一次是否有新数据
    syncCheckInterval = setInterval(checkSyncStatus, 5000);
}

// 页面加载时执行一次同步
window.addEventListener('DOMContentLoaded', function() {
    // 首次自动同步（静默执行）
    syncExcelRows(true);
    // 开始倒计时
    startSyncCountdown();
    // 开始定期检查同步状态
    startSyncStatusCheck();
});

</script>
{% endblock %}

